var model=require("../../model.js"),pageSize=model.db.config.clientSize,auth=require("./auth.js"),Question=model.question,Comment=model.comment;module.exports=function(e){e.get("/ask",auth.checkLogin),e.get("/ask",function(e,t){t.render("Client/ask.html",{user:e.session.user,websiteTitle:model.db.config.websiteTitle})}),e.get("/ask/:id",auth.checkLogin),e.get("/ask/:id",function(e,t){Question.getFilter({_id:e.params.id}).then(n=>{t.render("Client/ask.html",{user:e.session.user,websiteTitle:model.db.config.websiteTitle,id:e.params.id,question:n})})}),e.post("/ask",auth.checkLogin),e.post("/ask",function(e,t){e.body.id?Question.update({content:e.body.content},{where:{_id:e.body.id}}).then(e=>{t.redirect("/personal")}):Question.create({title:e.body.name,content:e.body.content,answer:"",createdBy:e.session.user._id,createdName:e.session.user.name}).then(e=>{t.redirect("/")})}),e.post("/ask/search",function(e,t){var n=e.query.p?parseInt(e.query.p):1,i={isChecked:1};e.body.q&&e.body.q.trim()&&(i.title={$like:`%${e.body.q.trim()}%`}),Question.getFiltersWithPageClient(n,i).then(function(e){t.jsonp({questions:e.rows,total:e.count,page:n,isFirstPage:n-1==0,isLastPage:(n-1)*pageSize+e.rows.length==e.count})}).catch(e=>{})}),e.post("/ask/personal",function(e,t){var n=e.query.p?parseInt(e.query.p):1,i={createdBy:e.session.user._id};Question.getFiltersWithPageClient(n,i).then(function(e){t.jsonp({questions:e.rows,total:e.count,page:n,isFirstPage:n-1==0,isLastPage:(n-1)*pageSize+e.rows.length==e.count})}).catch(e=>{})}),e.get("/question/:id",function(e,t){t.render("Client/detail.html",{user:e.session.user,websiteTitle:model.db.config.websiteTitle,id:e.params.id})}),e.post("/question",function(e,t){Question.getFilter({_id:e.body.id,isChecked:1}).then(function(e){t.jsonp(e)})}),e.post("/comment/get",function(e,t){Comment.getFilters({qid:e.body.id}).then(function(e){t.jsonp({comments:e})})}),e.post("/comment/post",function(e,t){Comment.create({qid:e.body.id,content:e.body.comment,createdBy:e.session.user._id,createdName:e.session.user.name}).then(function(e){t.jsonp(e)})})};