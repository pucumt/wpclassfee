function toxml(e){var t="<xml>";return e.forEach(function(e){t=t+"<"+e.key+"><![CDATA["+e.value+"]]></"+e.key+">"}),t+="</xml>"}function mysubstr(e,t,o){var r=e.indexOf(t),s=e.substr(r),a=s.indexOf(o);return s.substr(23,a-23)}var https=require("https"),zlib=require("zlib"),crypto=require("crypto");module.exports=function(e){e.get("/test",function(e,t){t.render("Test/irecorder.html",{title:"测试支付"})}),e.post("/test",function(e,t){var o=[],r="service=pay.weixin.native&mch_id=101560037142&out_trade_no="+e.body.orderId+"&body="+e.body.body1+"&total_fee="+e.body.orderAmount+"&mch_create_ip=127.0.0.1&notify_url=http://zhangwei.dev.swiftpass.cn/demo/TenpayResult.asp&nonce_str=testnonce&key=e6371d360d79eb9fa4c25c7f91d2bc6b";r="body=1&mch_create_ip=127.0.0.1&mch_id=101560037142&nonce_str=51cps&notify_url=http://zhangwei.dev.swiftpass.cn/demo/TenpayResult.asp&out_trade_no=201744227240&service=pay.weixin.native&total_fee=1&key=e6371d360d79eb9fa4c25c7f91d2bc6b",o.push({key:"body",value:"1"}),o.push({key:"mch_create_ip",value:"127.0.0.1"}),o.push({key:"mch_id",value:"101560037142"}),o.push({key:"nonce_str",value:"51cps"}),o.push({key:"notify_url",value:"http://zhangwei.dev.swiftpass.cn/demo/TenpayResult.asp"}),o.push({key:"out_trade_no",value:"201744227240"}),o.push({key:"service",value:"pay.weixin.native"}),o.push({key:"total_fee",value:"1"});var s=crypto.createHash("md5").update(r).digest("hex").toUpperCase();o.push({key:"sign",value:s});var a=toxml(o),n=https.request({hostname:"pay.swiftpass.cn",port:443,path:"/pay/gateway",method:"POST"},function(e){console.log("statusCode:",e.statusCode),console.log("headers:",e.headers),e.on("data",function(e){var o=mysubstr(e.toString(),"<code_img_url><![CDATA[","]]></code_img_url>");t.render("Test/pay.html",{title:"测试支付",imgCode:o})})});n.on("error",function(e){console.error(e)}),n.write(a),n.end()})};