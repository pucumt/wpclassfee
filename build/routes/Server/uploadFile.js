var xlsx=require("node-xlsx"),rawXLSX=require("xlsx"),path=require("path"),multer=require("multer"),fs=require("fs"),model=require("../../model.js"),pageSize=model.db.config.pageSize,StudentAccount=model.studentAccount,StudentInfo=model.studentInfo,ScoreFails=model.scoreFails,AddStudentToClassFails=model.addStudentToClassFails,AdminEnrollExam=model.adminEnrollExam,AdminEnrollTrain=model.adminEnrollTrain,AdminEnrollExamScore=model.adminEnrollExamScore,ExamClass=model.examClass,TrainClass=model.trainClass,auth=require("./auth"),archiver=require("archiver"),crypto=require("crypto"),Year=model.year,Grade=model.grade,Subject=model.subject,Category=model.category,ClassRoom=model.classRoom,SchoolArea=model.schoolArea,ClassAttribute=model.classAttribute,RebateEnrollTrain=model.rebateEnrollTrain,Coupon=model.coupon,CouponAssign=model.couponAssign,Teacher=model.teacher,OrderFromBank=model.orderFromBank,Lesson=model.lesson,LessonContent=model.lessonContent,Book=model.book,util=require("util"),request=require("request"),checkLogin=auth.checkLogin,serverPath=path.join(__dirname,"../"),storage=multer.diskStorage({destination:function(e,t,n){n(null,"./public/uploads/")},filename:function(e,t,n){n(null,t.originalname)}}),upload=multer({storage:storage});module.exports=function(e){function t(e,t,r,a){return StudentAccount.getFilter({name:e[1]}).then(function(i){return i?StudentInfo.getFilter({accountId:i._id,name:e[0]}).then(function(o){return o?AdminEnrollExam.getFilter({examId:t,studentId:o._id,isSucceed:1}).then(function(s){return s?AdminEnrollExamScore.getFilter({examOrderId:s._id,subjectId:r}).then(function(t){var n=o.name+"_"+i.name+"_"+a+"_"+s.examName.substr(0,19)+".pdf";return t?AdminEnrollExamScore.update({score:e[2],report:n},{where:{_id:t._id}}):AdminEnrollExamScore.create({examOrderId:s._id,subjectId:r,subjectName:a,score:e[2],report:n})}):n(e[0],e[1],e[2],t,r)}):n(e[0],e[1],e[2],t,r)}):n(e[0],e[1],e[2],t,r)})}function n(e,t,n,r,a){return ScoreFails.create({name:e,mobile:t,score:n,examId:r,subject:a})}function r(e){return OrderFromBank.getFilter({orderId:e[8].substr(1)}).then(function(t){if(!t)return OrderFromBank.create({orderDate:e[0].substr(1),orderId:e[8].substr(1),machine:e[5].substr(1),payType:e[10].substr(1),trainPrice:e[14].substr(1)}).catch(function(e){console.log(e)})})}function a(e,t,n){var r=[],a=[],i=[];if(t.exams){var o=t.exams;return TrainClassExam.getFilters({trainClassId:e}).then(function(s){return o.forEach(function(t){var i;s.some(e=>{if(e.examId==t.examId)return e.minScore=t.minScore,i=e,!0})?a.push(i):(t._id=model.db.generateId(),t.trainClassId=e,t.createdBy=n,r.push(t))}),s.forEach(e=>{a.some(t=>e.examId==t.examId)||i.push(e._id)}),model.db.sequelize.transaction(function(o){return TrainClass.update(t,{where:{_id:e},transaction:o}).then(function(e){var t=[];if(r.length>0){s=TrainClassExam.bulkCreate(r,{transaction:o});t.push(s)}if(i.length>0){var s=TrainClassExam.update({isDeleted:!0,deletedBy:n,deletedDate:new Date},{where:{_id:{$in:i}},transaction:o});t.push(s)}return a.length>0&&a.forEach(e=>{var n=e.save({transaction:o});t.push(n)}),Promise.all(t)})})})}return TrainClass.update(t,{where:{_id:e}})}function i(e,t){var n={name:e[0].trim(),totalStudentCount:e[9],totalClassCount:e[8],trainPrice:e[10],materialPrice:e[11],courseStartDate:new Date(1900,0,parseInt(e[5])-1),courseEndDate:new Date(1900,0,parseInt(e[6])-1),courseTime:e[7],courseContent:e[18]&&e[18].trim()};return Year.getFilter({name:e[1].trim()}).then(function(r){return r?(n.yearId=r._id,n.yearName=r.name,Grade.getFilter({name:e[2].trim()}).then(function(r){return r?(n.gradeId=r._id,n.gradeName=r.name,Subject.getFilter({name:e[3].trim()}).then(function(r){return r?(n.subjectId=r._id,n.subjectName=r.name,Category.getFilter({name:e[4].trim()}).then(function(r){if(r){n.categoryId=r._id,n.categoryName=r.name;return(e[12]&&""!=e[12].trim()?ClassAttribute.getFilter({name:e[12].trim()}):Promise.resolve()).then(function(r){r&&(n.attributeId=r._id,n.attributeName=r.name);return(e[13]&&""!=e[13].trim()?ClassRoom.getFilter({name:e[13].trim()}):Promise.resolve()).then(function(r){return r&&(n.classRoomId=r._id,n.classRoomName=r.name),SchoolArea.getFilter({name:e[14].trim()}).then(function(r){if(r){n.schoolId=r._id,n.schoolArea=r.name;var i,s=[];if(e[15]&&""!=e[15].trim()){var l=[];e[15].split(",").forEach(function(e){var t=e.split(":"),n=ExamClass.getFilter({name:t[0].trim()}).then(function(e){s.push({examId:e._id,examName:e.name,minScore:t[1].trim()})});l.push(n)}),i=Promise.all(l)}else i=Promise.all([]);return i.then(function(){s.length>0&&(n.exams=s);return(e[16]&&""!=e[16].trim()?TrainClass.getFilter({name:e[16].trim(),schoolArea:e[19].trim(),yearName:e[20].trim()}):Promise.resolve()).then(function(r){if(r)n.fromClassId=r._id,n.fromClassName=r.name,n.isWeixin=2;else if(e[16]&&""!=e[16].trim())return o("","",e[0].trim(),"没找到原班");return TrainClass.getFilter({name:e[0].trim(),schoolArea:e[14].trim(),yearName:e[1].trim()}).then(function(e){return e?(delete n.isWeixin,a(e._id,n,t)):(n.createdBy=t,TrainClass.create(n))})})})}return o("","",e[0].trim(),"没找到校区")}).catch(function(){return o("","",e[0].trim(),"没找到校区")})}).catch(function(){return o("","",e[0].trim(),"没找到教室")})}).catch(function(){return o("","",e[0].trim(),"没找到属性")})}return o("","",e[0].trim(),"没找到难度")}).catch(function(){return o("","",e[0].trim(),"没找到难度")})):o("","",e[0].trim(),"没找到科目")}).catch(function(){return o("","",e[0].trim(),"没找到科目")})):o("","",e[0].trim(),"没找到年级")}).catch(function(){return o("","",e[0].trim(),"没找到年级")})):o("","",e[0].trim(),"没找到年度")}).catch(function(){return o("","",e[0].trim(),"没找到年度")})}function o(e,t,n,r){return AddStudentToClassFails.create({name:e,mobile:t,className:n,reason:r})}function s(e){var t={isPayed:!0};return TrainClass.getFilter({name:e[0].trim(),schoolArea:e[3].trim(),yearName:e[8].trim()}).then(function(n){return n?(t.trainId=n._id,t.trainName=n.name,t.yearId=n.yearId,t.yearName=n.yearName,t.schoolId=n.schoolId,t.schoolArea=n.schoolArea,StudentInfo.getFilter({name:e[1].trim(),mobile:e[2]}).then(function(r){return r?(t.studentId=r._id,t.studentName=r.name,AdminEnrollTrain.getFilter({trainId:n._id,studentId:r._id,isSucceed:1}).then(function(e){if(!e)return AdminEnrollTrain.create(t)})):Grade.getFilter({name:e[5]&&e[5].trim()}).then(function(r){return r?StudentAccount.getFilter({name:e[2]}).then(function(a){var i;if(a)i=Promise.resolve(a);else{var s=crypto.createHash("md5");i=StudentAccount.create({name:e[2],password:password=s.update("111111").digest("hex")})}return i.then(function(a){return a?StudentInfo.create({name:e[1].trim(),sex:!e[7]||"男"!=e[7].trim(),accountId:a._id,mobile:e[2],gradeId:r._id,gradeName:r.name,School:e[4]&&e[4].trim(),className:e[6]}).then(function(r){return r?(t.studentId=r._id,t.studentName=r.name,AdminEnrollTrain.getFilter({trainId:n._id,studentId:r._id,isSucceed:1}).then(function(e){if(!e)return AdminEnrollTrain.create(t)})):o(e[1].trim(),e[2],e[0].trim(),"新增学生出错")}):o(e[1].trim(),e[2],e[0].trim(),"添加账号出错")})}):o(e[1].trim(),e[2],e[0].trim(),"没找到年级")})})):o(e[1].trim(),e[2],e[0].trim(),"没找到班级")})}function l(e){switch(e){case 0:return"现金";case 1:return"刷卡";case 2:return"转账";case 8:return"支付宝";case 9:return"微信";case 6:case 7:return"在线"}return""}function d(e){return e.fromId?AdminEnrollTrain.getFilter({_id:e.fromId}).then(function(e){return d(e)}):Promise.resolve(l(e.payWay))}function u(e){return StudentInfo.getFilter({name:e[0]}).then(function(t){return t?t.mobile!=e[1]?n(e[0],e[1],t.mobile,"该学生号码不匹配"):void 0:n(e[0],e[1],"","没找到该学生")})}function c(e,t,r){return StudentInfo.getFilter({name:e[0],mobile:e[1]}).then(function(a){return a?Coupon.getFilter({_id:t}).then(function(e){return CouponAssign.getFilter({couponId:e._id,studentId:a._id}).then(function(t){if(!t)return CouponAssign.create({couponId:e._id,couponName:e.name,gradeId:e.gradeId,gradeName:e.gradeName,subjectId:e.subjectId,subjectName:e.subjectName,reducePrice:e.reducePrice,couponStartDate:e.couponStartDate,couponEndDate:e.couponEndDate,studentId:a._id,studentName:a.name,createdBy:r._id})})}):n(e[0],e[1],"","没找到该学生")})}function m(e,t){return StudentInfo.getFilter({name:e[0],mobile:e[1]}).then(function(r){return r?Coupon.getFilter({_id:t}).then(function(t){return t?CouponAssign.update({isDeleted:!0},{where:{couponId:t._id,studentId:r._id}}):n(e[0],e[1],"","没找到该优惠券")}):n(e[0],e[1],"","没找到该学生")})}function h(e){return SchoolArea.getFilter({name:e[2].trim()}).then(function(t){return t?ClassRoom.getFilter({name:e[0],schoolId:t._id}).then(function(n){if(!n)return ClassRoom.create({name:e[0],sCount:e[1],schoolId:t._id,schoolArea:t.name})}):n(e[0],e[1],e[2],"没找到校区")})}function f(e){return Teacher.getFilter({name:e[0].trim(),mobile:e[2]}).then(function(t){if(!t){var n=crypto.createHash("md5");return Teacher.create({name:e[0].trim(),mobile:e[2],engName:e[1]&&e[1].trim(),password:n.update("111111").digest("hex")})}})}function p(e){var t={};return TrainClass.getFilter({name:e[0].trim(),schoolArea:e[2].trim(),yearName:e[8].trim()}).then(function(r){if(r){return(e[9]&&""!=e[9].trim()?ClassRoom.getFilter({name:e[9].trim(),schoolArea:e[2].trim()}):Promise.resolve()).then(function(a){a&&(t.classRoomId=a._id,t.classRoomName=a.name);return(e[6]?Teacher.getFilter({mobile:e[6]}):Promise.resolve()).then(function(a){if(a){t.teacherId=a._id,t.teacherName=a.name;return(e[10]&&""!=e[10].trim()?Book.getFilter({name:e[10].trim()}):Promise.resolve()).then(function(n){return n&&(t.bookId=n._id,t.minLesson=e[11],t.maxLesson=e[12]),TrainClass.update(t,{where:{_id:r._id}})})}return n(e[0].trim(),e[2].trim(),e[8].trim(),"没找到老师")})})}return n(e[0].trim(),e[2].trim(),e[8].trim(),"没找到课程")})}function g(e,t){switch(e){case"0":return"课文";case"1":return util.format("第%d个单词",t);case"2":return util.format("第%d个句子",t)}}function b(e){fs.existsSync(e)||fs.mkdirSync(e)}function x(e,t,n,r){var a=path.join(serverPath,"../public/uploads/books",e),i=path.join(a,t),o=path.join(i,n+".mp3");b(a),b(i),fs.renameSync(r,o)}function I(e,t,n){var r=e[t];if(r&&r[0]){var a=r[2].split(";"),i=a[0].split(":")[1],o=a[4].split(":")[1],s=a[3].substr(5),l=path.join(n,"pics",i+o+".jpg");if(fs.existsSync(l))I(e,t+1,n);else request(s).pipe(fs.createWriteStream(l)).on("close",function(){I(e,t+1,n)})}}e.get("/admin/score",checkLogin),e.get("/admin/score",function(e,t){t.render("Server/scoreResult.html",{title:">成绩导入结果失败列表",user:e.session.admin})}),e.get("/admin/score/clearAll",checkLogin),e.get("/admin/score/clearAll",function(e,t){ScoreFails.destroy({where:{}}).then(function(){t.jsonp({sucess:!0})})}),e.post("/admin/score",upload.single("avatar"),function(e,n,r){var a=xlsx.parse(path.join(serverPath,"../public/uploads/",e.file.filename));Subject.getFilter({_id:e.body.subject}).then(function(r){for(var i=a[0].data.length,o=[],s=1;s<i&&a[0].data[s][0];s++)o.push(t(a[0].data[s],e.body.examId,r._id,r.name));Promise.all(o).then(function(){n.jsonp({sucess:!0})})})}),e.post("/admin/uploadBank",upload.single("avatar"),function(e,t,n){for(var a=xlsx.parse(path.join(serverPath,"../public/uploads/",e.file.filename)),i=a[0].data.length,o=[],s=1;s<i&&a[0].data[s][0];s++)o.push(r(a[0].data[s]));Promise.all(o).then(function(){t.jsonp({sucess:!0})})}),e.post("/admin/batchTrainClass",upload.single("avatar"),function(e,t,n){for(var r=xlsx.parse(path.join(serverPath,"../public/uploads/",e.file.filename)),a=r[0].data.length,o=[],s=1;s<a&&r[0].data[s][0];s++)o.push(i(r[0].data[s]),e.session.admin._id);Promise.all(o).then(function(){t.jsonp({sucess:!0})})}),e.get("/admin/batchAddStudentToTrainClassResult",checkLogin),e.get("/admin/batchAddStudentToTrainClassResult",function(e,t){t.render("Server/batchAddStudentToTrainClassResult.html",{title:">老生班级导入结果失败列表",user:e.session.admin})}),e.get("/admin/batchAddStudentToTrainClass/clearAll",checkLogin),e.get("/admin/batchAddStudentToTrainClass/clearAll",function(e,t){AddStudentToClassFails.destroy({where:{}}).then(function(){t.jsonp({sucess:!0})})}),e.get("/admin/batchAddStudentToTrainClass/all",checkLogin),e.get("/admin/batchAddStudentToTrainClass/all",function(e,t){AddStudentToClassFails.getFilters({}).then(function(e){t.jsonp(e)}).catch(function(e){console.log("errored")})}),e.post("/admin/batchAddStudentToTrainClass",upload.single("avatar"),function(e,t,n){var r=xlsx.parse(path.join(serverPath,"../public/uploads/",e.file.filename)),a=r[0].data.length,i=function(e){e>=a||!r[0].data[e][0]?t.jsonp({sucess:!0}):s(r[0].data[e]).then(function(){i(e+1)})};i(1)}),e.get("/admin/score/getAllWithoutPage",checkLogin),e.get("/admin/score/getAllWithoutPage",function(e,t){ScoreFails.getFilters({}).then(function(e){t.jsonp(e)}).catch(function(e){console.log("errored")})}),e.post("/admin/export/scoreTemplate",function(e,t){var n=[["姓名","联系方式","成绩"]];AdminEnrollExam.getFilters({examId:e.body.examId,isSucceed:1}).then(function(e){if(e.length>0){var t=[];return e.forEach(function(e){var r=StudentInfo.getFilter({_id:e.studentId}).then(function(t){if(t&&t.accountId)return StudentAccount.getFilter({_id:t.accountId}).then(function(e){n.push([t.name,e.name])});n.push([e.studentId,e._id])});t.push(r)}),Promise.all(t)}}).then(function(){var r=xlsx.build([{name:"成绩",data:n}]),a=e.body.exam.substr(0,19)+"_"+e.body.subject+".xlsx";fs.writeFileSync(path.join(serverPath,"../public/downloads/",a),r,"binary"),t.jsonp({sucess:!0})})}),e.post("/admin/export/scoreSchoolTemplate",function(e,t){var n=[["姓名","联系方式","考场","学校","班级","成绩"]];AdminEnrollExam.getFilters({examId:e.body.examId,isSucceed:1}).then(function(e){if(e.length>0){var t=[];return e.forEach(function(e){var r=StudentInfo.getFilter({_id:e.studentId}).then(function(t){if(t&&t.accountId)return StudentAccount.getFilter({_id:t.accountId}).then(function(r){n.push([t.name,r.name,e.examAreaName,t.School,t.className])});n.push([e.studentId,e._id])});t.push(r)}),Promise.all(t)}}).then(function(){var r=xlsx.build([{name:"成绩",data:n}]),a=e.body.exam.substr(0,19)+"_"+e.body.subject+".xlsx";fs.writeFileSync(path.join(serverPath,"../public/downloads/",a),r,"binary"),t.jsonp({sucess:!0})})}),e.get("/admin/export/scoreTemplate",checkLogin),e.get("/admin/export/scoreTemplate",function(e,t){t.render("Server/scoreTemplate.html",{title:">成绩模板导出",user:e.session.admin,name:decodeURI(e.query.name)})}),e.post("/admin/export/reportTemplate",function(e,t){t.jsonp({sucess:!0})}),e.post("/admin/export/classTemplate3",function(e,t){var n=[["姓名","联系方式","科目","时间","校区","培训费","教材费","科目","时间","校区","培训费","教材费","科目","时间","校区","培训费","教材费"]];AdminEnrollExam.getFilters({examId:e.body.examId,isSucceed:1}).then(function(e){if(e.length>0){var t=[];return e.forEach(function(e){var r=StudentInfo.getFilter({_id:e.studentId}).then(function(t){if(t){var r=[],a=[t.name,t.mobile,"","","","","","","","","","","","","","",""];return AdminEnrollTrain.getFilters({studentId:t._id,isSucceed:1,yearId:global.currentYear._id}).then(function(e){return e&&e.length>0?(e.forEach(function(e){var t=TrainClass.getFilter({_id:e.trainId}).then(function(t){switch(t.subjectName){case"语文":a[2]="语文",a[3]=t.courseTime,a[4]=t.schoolArea,a[5]=e.totalPrice,a[6]=e.realMaterialPrice;break;case"数学":a[7]="数学",a[8]=t.courseTime,a[9]=t.schoolArea,a[10]=e.totalPrice,a[11]=e.realMaterialPrice;break;case"英语":a[12]="英语",a[13]=t.courseTime,a[14]=t.schoolArea,a[15]=e.totalPrice,a[16]=e.realMaterialPrice}});r.push(t)}),Promise.all(r)):Promise.all([])}).then(function(){n.push(a)})}n.push([e.studentId,e._id])});t.push(r)}),Promise.all(t)}}).then(function(){var e=xlsx.build([{name:"报名情况",data:n}]);fs.writeFileSync(path.join(serverPath,"../public/downloads/","报名情况3.xlsx"),e,"binary"),t.jsonp({sucess:!0})})}),e.post("/admin/export/classTemplate5",function(e,t){var n=[["姓名","联系方式","学生学校","学生班级","性别","报名日期","科目","校区","课程","上课时间","年级","培训费","教材费","退费","支付方式","备注"]],r={isDeleted:!1,isSucceed:1,yearId:global.currentYear._id,isPayed:!0};AdminEnrollTrain.getFiltersWithClass(r).then(function(e){if(e.length>0){var t=[];return e.forEach(function(e){var r=StudentInfo.get(e.studentId).then(function(t){if(t)return d(e).then(function(r){var a=e.trainClasss[0]||{},i=[t.name,t.mobile,t.School,t.className,t.sex?"女":"男",e.orderDate,a.subjectName,a.schoolArea,a.name,a.courseTime,a.gradeName,e.totalPrice,e.realMaterialPrice,e.rebatePrice,r,e.comment];n.push(i)});n.push([e.studentId,e._id,e.orderDate,e.trainId])});t.push(r)}),Promise.all(t)}}).then(function(){var e=xlsx.build([{name:"报名情况",data:n}]);fs.writeFileSync(path.join(serverPath,"../public/downloads/","报名情况5.xlsx"),e,"binary"),t.jsonp({sucess:!0})})}),e.post("/admin/export/classTemplate6",function(e,t){var n=[["课程","科目","校区","年级","时间","已报","总数"]];return TrainClass.getFilters({yearId:global.currentYear._id}).then(function(e){if(e.length>0){e.forEach(function(e){var t=[e.name,e.subjectName,e.schoolArea,e.gradeName,e.courseTime,e.enrollCount,e.totalStudentCount];n.push(t)});var r=xlsx.build([{name:"报名情况",data:n}]);fs.writeFileSync(path.join(serverPath,"../public/downloads/","报名情况6.xlsx"),r,"binary"),t.jsonp({sucess:!0})}})}),e.post("/admin/adminEnrollTrain/addYearToOrder",checkLogin),e.post("/admin/adminEnrollTrain/addYearToOrder",function(e,t){AdminEnrollTrain.getFilters({yearId:null}).then(function(e){if(e&&e.length>0){var n=[];e.forEach(function(e){var t=TrainClass.get(e.trainId).then(function(t){if(t)return AdminEnrollTrain.update({yearId:t.yearId,yearName:t.yearName},{where:{_id:e._id}});o(e.trainId,"","","没找到课程")});n.push(t)}),Promise.all(n).then(function(){t.jsonp({sucess:!0})})}else t.jsonp({error:"没找到任何订单"})})}),e.post("/admin/adminEnrollTrain/addSchoolToOrder",checkLogin),e.post("/admin/adminEnrollTrain/addSchoolToOrder",function(e,t){AdminEnrollTrain.getFilters({}).then(function(e){if(e&&e.length>0){var n=[];e.forEach(function(e){var t=TrainClass.get(e.trainId).then(function(t){if(t)return AdminEnrollTrain.update({schoolId:t.schoolId,schoolArea:t.schoolArea},{where:{_id:e._id}});o(e.trainId,"","","没找到课程")});n.push(t)}),Promise.all(n).then(function(){t.jsonp({sucess:!0})})}else t.jsonp({error:"没找到任何订单"})})}),e.post("/admin/export/gradeMOneList",function(e,t){t.jsonp({sucess:!0})}),e.post("/admin/export/rebateAllList",function(e,t){var n=[["学生","电话","订单","课程","校区","年级","科目","退费","退费日期"]];RebateEnrollTrain.getFilters({}).then(function(e){var r=[];e.forEach(function(e){var t=AdminEnrollTrain.getFilter({_id:e.trainOrderId}).then(function(t){return TrainClass.getFilter({_id:t.trainId}).then(function(r){var a=[t.studentName,t.mobile,t._id,t.trainName,r.schoolArea,r.gradeName,r.subjectName,e.rebatePrice,e.createDate];n.push(a)})});r.push(t)}),Promise.all(r).then(function(){var e=xlsx.build([{name:"退费情况",data:n}]);fs.writeFileSync(path.join(serverPath,"../public/downloads/","全部退费列表.xlsx"),e,"binary"),t.jsonp({sucess:!0})})})}),e.post("/admin/export/otherOrder1",function(e,t){var n=[["学生","电话","订单","订单日期","课程","校区","年级","科目","退费"]];AdminEnrollTrain.getFilters({isSucceed:9,isPayed:!0,fromId:null,payWay:6}).then(function(e){var r=[];e.forEach(function(e){var t=AdminEnrollTrain.getFilter({fromId:e._id}).then(function(t){if(!t)return TrainClass.getFilter({_id:e.trainId}).then(function(t){var r=[e.studentName,e.mobile,e._id,e.orderDate,e.trainName,t.schoolArea,t.gradeName,t.subjectName,e.rebatePrice];n.push(r)})});r.push(t)}),Promise.all(r).then(function(){var e=xlsx.build([{name:"订单情况",data:n}]);fs.writeFileSync(path.join(serverPath,"../public/downloads/","已支付被取消订单.xlsx"),e,"binary"),t.jsonp({sucess:!0})})})}),e.post("/admin/export/rollCallList",function(e,t){}),e.post("/admin/checkstudent",upload.single("avatar"),function(e,t,n){for(var r=xlsx.parse(path.join(serverPath,"../public/uploads/",e.file.filename)),a=r[0].data.length,i=[],o=1;o<a&&r[0].data[o][0];o++)i.push(u(r[0].data[o]));Promise.all(i).then(function(){t.jsonp({})})}),e.post("/admin/coupon/batchAssign",upload.single("avatar"),function(e,t,n){for(var r=xlsx.parse(path.join(serverPath,"../public/uploads/",e.file.filename)),a=r[0].data.length,i=[],o=1;o<a&&r[0].data[o][0];o++)i.push(c(r[0].data[o],e.body.couponId,e.session.admin));Promise.all(i).then(function(){t.jsonp({sucess:!0})})}),e.post("/admin/coupon/batchDelete",upload.single("avatar"),function(e,t,n){for(var r=xlsx.parse(path.join(serverPath,"../public/uploads/",e.file.filename)),a=r[0].data.length,i=[],o=1;o<a&&r[0].data[o][0];o++)i.push(m(r[0].data[o],e.body.couponId));Promise.all(i).then(function(){t.jsonp({sucess:!0})})}),e.post("/admin/batchAddClassRoom",upload.single("avatar"),function(e,t,n){for(var r=xlsx.parse(path.join(serverPath,"../public/uploads/",e.file.filename)),a=r[0].data.length,i=[],o=1;o<a&&r[0].data[o][0];o++)i.push(h(r[0].data[o]));Promise.all(i).then(function(){t.jsonp({sucess:!0})})}),e.post("/admin/batchAddTeacher",upload.single("avatar"),function(e,t,n){for(var r=xlsx.parse(path.join(serverPath,"../public/uploads/",e.file.filename)),a=r[0].data.length,i=[],o=1;o<a&&r[0].data[o][0];o++)i.push(f(r[0].data[o]));Promise.all(i).then(function(){t.jsonp({sucess:!0})})}),e.post("/admin/batchAddTeacherToTrainClass",upload.single("avatar"),function(e,t,n){for(var r=xlsx.parse(path.join(serverPath,"../public/uploads/",e.file.filename)),a=r[0].data.length,i=[],o=1;o<a&&r[0].data[o][0];o++)i.push(p(r[0].data[o]));Promise.all(i).then(function(){t.jsonp({sucess:!0})})}),e.post("/admin/audio",upload.single("audio"),function(e,t,n){var r=e.body.contentType,a=parseInt(e.body.number)+1,i=e.body.lessonId,o=path.join(serverPath,"../public/uploads/",e.file.filename);LessonContent.findAll({where:{lessonId:i,contentType:r},order:[["sequence"],["createdDate"],["_id"]],offset:parseInt(e.body.number)}).then(function(e){e&&e.length>0?Lesson.getFilter({_id:i}).then(function(n){n?(x(n.bookId,i,e[0]._id,o),t.jsonp({sucess:!0})):t.jsonp({error:"沒有找到该书！"})}).catch(function(){t.jsonp({error:"拷贝音频出错！"})}):t.jsonp({error:"沒有找到"+g(r,a)})})}),e.post("/admin/downloadPic",upload.single("avatar"),function(e,t,n){var r=path.join(serverPath,"../public/uploads/");I(xlsx.parse(path.join(r,e.file.filename))[0].data,1,r),t.jsonp({})})};